{% extends 'core/base.html' %}

{% block navbar %}{% endblock %}
{% block footer %}{% endblock %}
{% block padding_top %}pt-0{% endblock %}

{% block content %}
<!-- Full Height Workspace Container -->
<div class="min-h-screen lg:h-screen flex flex-col lg:flex-row lg:overflow-hidden bg-[#0f172a]">

    <!-- LEFT PANEL: EVIDENCE (DATASET) -->
    <div
        class="w-full lg:w-1/2 flex flex-col border-r border-slate-700/50 bg-slate-900/50 h-[60vh] lg:h-full shrink-0 min-w-0">
        <!-- Toolbar -->
        <div
            class="h-16 flex items-center justify-between px-6 border-b border-slate-700/50 bg-slate-800/20 backdrop-blur shrink-0">
            <div class="flex items-center gap-3">
                <a href="{% url 'dashboard' %}"
                    class="w-8 h-8 rounded bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition-all"
                    title="Back to Dashboard">
                    ‚Üê
                </a>
                <div class="h-6 w-px bg-slate-700 mx-2 hidden sm:block"></div>
                <div class="w-8 h-8 rounded bg-cyan-500/10 hidden sm:flex items-center justify-center text-cyan-400">
                    üìÇ
                </div>
                <div>
                    <span class="block font-bold text-slate-200 text-sm leading-tight">Evidence Files</span>
                    <span
                        class="text-[10px] text-slate-500 uppercase tracking-wider block truncate max-w-[100px] sm:max-w-none">
                        {% if case.dataset %}{{ case.dataset.name }}{% else %}titanic_manifest.csv{% endif %}
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative group hidden sm:block">
                    <input type="text" placeholder="Search data..."
                        class="bg-slate-950 border border-slate-800 rounded-lg pl-8 pr-3 py-1.5 text-xs text-slate-300 focus:outline-none focus:border-cyan-500/50 w-48 transition-all focus:w-64">
                    <span class="absolute left-2.5 top-1.5 text-slate-600">üîç</span>
                </div>
                <button
                    class="p-1.5 text-slate-400 hover:text-white transition-colors bg-slate-800 border border-slate-700 rounded-md sm:hidden"
                    title="Search">üîç</button>
                <button
                    class="p-1.5 text-slate-400 hover:text-white transition-colors bg-slate-800 border border-slate-700 rounded-md"
                    title="Filter">üå™Ô∏è</button>
            </div>
        </div>

        <!-- CSV Grid (Excel-like) -->
        <div class="flex-1 overflow-auto relative custom-scrollbar bg-[#0B1120]">
            <!-- Mock Table for UI - Will be Hydrated by JS later -->
            <table class="w-full text-left text-sm text-slate-400 border-collapse">
                <thead class="bg-slate-800/80 text-slate-300 sticky top-0 z-10 shadow-sm backdrop-blur-sm">
                    <tr>
                        <!-- Auto-Index Header -->
                        <th
                            class="px-4 py-3 font-mono text-xs border-b border-slate-700 whitespace-nowrap bg-slate-800/50 text-slate-500 w-12 text-center select-none">
                            #</th>

                        {% for col in columns %}
                        <th
                            class="px-4 py-3 font-semibold text-xs border-b border-slate-700 whitespace-nowrap group cursor-pointer hover:bg-slate-700/50 transition-colors border-r border-slate-700/30 last:border-r-0">
                            {{ col }} <span
                                class="invisible group-hover:visible text-[10px] text-cyan-500 ml-1">‚ñº</span>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800/30">
                    {% for row in rows %}
                    <tr class="hover:bg-cyan-500/5 transition-colors cursor-pointer group">
                        <!-- Row Index -->
                        <td
                            class="px-4 py-2 font-mono text-[10px] text-slate-600 border-r border-slate-800/50 bg-slate-900/40 text-center select-none">
                            {{ forloop.counter }}</td>

                        {% for cell in row %}
                        <td class="px-4 py-2 text-xs border-r border-dashed border-slate-800/30 truncate max-w-[200px] text-slate-400 group-hover:text-slate-200"
                            title="{{ cell }}">
                            {{ cell }}
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="100" class="h-64 text-center">
                            <div class="flex flex-col items-center justify-center opacity-50">
                                <span class="text-4xl mb-4">üì≠</span>
                                <p class="text-slate-400 italic">No data available yet.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer Info -->
        <div
            class="h-8 bg-[#0a0f1c] border-t border-slate-800 flex items-center px-4 text-[10px] text-slate-600 font-mono justify-between shrink-0">
            <span>READY</span>
            <span>UTF-8 ‚Ä¢ CSV ‚Ä¢ 15,000 ROWS</span>
        </div>
    </div>


    <!-- RIGHT PANEL: DETECTIVE TOOLS -->
    <div
        class="w-full lg:w-1/2 flex flex-col bg-[#0f172a] relative border-l border-slate-800 shadow-2xl h-auto lg:h-full min-w-0">

        <!-- Workspace Header (Compact Nav) -->
        <div
            class="h-16 flex items-center justify-between px-6 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md shrink-0">
            <!-- Left: Branding & Case Title -->
            <div class="flex items-center gap-6">
                <a href="/"
                    class="text-xl font-bold font-heading tracking-wide flex items-center gap-2 hover:opacity-80 transition-opacity">
                    <span class="text-2xl text-cyan-400">üïµÔ∏è</span>
                </a>
                <div class="h-8 w-px bg-slate-700/50 hidden sm:block"></div>
                <div class="hidden sm:block">
                    <span class="text-[10px] font-bold text-cyan-500 uppercase tracking-widest block mb-0.5">Current
                        Mission</span>
                    <h1 class="font-bold text-white text-md flex items-center gap-2 truncate max-w-[200px]">
                        {{ case.title }}
                    </h1>
                </div>
            </div>

            <!-- Right: Navigation & Actions -->
            <div class="flex items-center gap-4">
                <!-- Nav Links -->
                <nav class="hidden xl:flex items-center gap-4 text-xs font-bold text-slate-400 mr-4">
                    <a href="{% url 'dashboard' %}" class="hover:text-white transition-colors">DASHBOARD</a>
                    <a href="/leaderboard" class="hover:text-white transition-colors">LEADERBOARD</a>
                </nav>

                <!-- Timer -->
                <div
                    class="hidden sm:flex items-center gap-2 bg-slate-950 px-3 py-1.5 rounded border border-slate-800 shadow-inner">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="font-mono text-cyan-400 font-bold text-sm tracking-wider">00:45:12</span>
                </div>

                <!-- Save Button -->
                <button
                    class="bg-cyan-600/10 hover:bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 hover:border-cyan-500/50 rounded px-3 py-1.5 text-xs font-bold flex items-center gap-2 transition-all group">
                    <span>üíæ</span> <span class="group-hover:text-cyan-300">Save</span>
                </button>
            </div>
        </div>

        <!-- Tool Tabs -->
        <div
            class="flex items-center px-4 bg-slate-900/30 border-b border-slate-800 gap-4 pt-3 pb-1 overflow-x-auto no-scrollbar whitespace-nowrap shrink-0">
            <div class="flex items-center gap-2">
                <button onclick="switchTab('brief')" id="tab-brief"
                    class="tab-btn px-4 py-2 text-xs font-bold rounded-lg border border-transparent text-slate-400 hover:text-white hover:bg-slate-800 transition-all flex items-center gap-2">
                    <span>üìù</span> Briefing
                </button>
                <button onclick="switchTab('sql')" id="tab-sql"
                    class="tab-btn px-4 py-2 text-xs font-bold rounded-lg border border-transparent text-slate-400 hover:text-white hover:bg-slate-800 transition-all flex items-center gap-2">
                    <span>‚ö°</span> SQL Engine
                </button>
                <button onclick="switchTab('python')" id="tab-python"
                    class="tab-btn px-4 py-2 text-xs font-bold rounded-lg border border-transparent text-slate-400 hover:text-white hover:bg-slate-800 transition-all flex items-center gap-2">
                    <span>üêç</span> Python
                </button>
            </div>

            <div class="h-6 w-px bg-slate-800 mx-1 shrink-0"></div>

            <button onclick="switchTab('submit')" id="tab-submit"
                class="tab-btn px-4 py-2 text-xs font-bold rounded-lg border border-amber-500/30 text-amber-500/80 bg-amber-500/5 hover:bg-amber-500/10 hover:text-amber-400 transition-all flex items-center gap-2 shadow-lg shadow-amber-900/10 ml-auto md:ml-0">
                <span>‚úÖ</span> Submit Findings
            </button>
        </div>

        <!-- Tab Content Area -->
        <div id="content-area"
            class="flex-1 overflow-y-auto p-0 relative group custom-scrollbar bg-[#0f172a] scroll-smooth min-h-[500px] lg:min-h-0">

            <!-- BRIEFING TAB -->
            <div id="view-brief" class="tab-view p-6 md:p-12 space-y-10 max-w-5xl mx-auto">

                <!-- Progress Tracker -->
                <div class="bg-slate-900/50 rounded-xl border border-slate-700/50 p-6 backdrop-blur-sm mb-8">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Case Progress</span>
                        <span class="text-sm font-bold text-cyan-400">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                        <div class="bg-cyan-500 h-full w-0 shadow-[0_0_10px_rgba(6,182,212,0.5)]"></div>
                    </div>
                    <div class="mt-4 flex gap-4 text-xs text-slate-500 font-mono">
                        <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-slate-700"></span>
                            0 Submitted</span>
                        <span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-slate-700"></span>
                            {{ case.questions.count }} Objectives</span>
                    </div>
                </div>

                <div class="prose prose-invert prose-sm max-w-none">
                    <div class="flex items-start gap-4 mb-8">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shrink-0 shadow-lg shadow-cyan-500/20">
                            <span class="text-2xl">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold font-heading text-white m-0">Case Background</h2>
                            <p class="text-slate-400 text-sm mt-1">Classified ‚Ä¢ Top Secret Clearance</p>
                        </div>
                    </div>

                    <p class="text-slate-300 leading-relaxed text-base">{{ case.description }}</p>

                    <div
                        class="my-8 p-5 border-l-4 border-amber-500 bg-gradient-to-r from-amber-500/10 to-transparent rounded-r-lg">
                        <h4
                            class="font-bold text-amber-400 m-0 text-sm uppercase tracking-wide mb-2 flex items-center gap-2">
                            <span>üí°</span> Detective Note
                        </h4>
                        <p class="m-0 text-sm text-amber-100/90 italic">"Pay close attention to the 'Fare' column. There
                            seems to be a discrepancy in the third-class tickets."</p>
                    </div>

                    <h3 class="text-lg font-bold text-white mt-8 mb-4 flex items-center gap-2">
                        <span>üéØ</span> Mission Objectives
                    </h3>
                    <div class="space-y-3">
                        {% for q in case.questions.all %}
                        <div
                            class="flex items-start gap-4 p-4 rounded-xl bg-slate-800/30 border border-slate-700/50 hover:border-slate-600 transition-colors group">
                            <div
                                class="w-8 h-8 rounded-lg bg-slate-800 flex items-center justify-center shrink-0 border border-slate-700 group-hover:border-slate-500 transition-colors">
                                {% if q.question_type == 'SQL' %}
                                <span class="text-sm">‚ö°</span>
                                {% elif q.question_type == 'PYTHON' %}
                                <span class="text-sm">üêç</span>
                                {% else %}
                                <span class="text-sm">‚ùì</span>
                                {% endif %}
                            </div>
                            <div>
                                <span
                                    class="text-[10px] uppercase font-bold text-slate-500 tracking-wider block mb-0.5">{{
                                    q.get_question_type_display }}</span>
                                <p class="text-slate-200 font-medium text-sm">{{ q.text }}</p>
                            </div>
                            <span
                                class="ml-auto text-xs font-bold text-cyan-500 opacity-0 group-hover:opacity-100 transition-opacity">+{{
                                q.points }} XP</span>
                        </div>
                        {% empty %}
                        <p class="text-slate-500 italic text-sm">No specific objectives loaded.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- SQL TAB -->
            <div id="view-sql" class="tab-view hidden p-8 space-y-8">
                <!-- Editor Section -->
                <div
                    class="flex flex-col bg-[#1e293b] rounded-xl overflow-hidden border border-slate-700 shadow-xl h-[300px] md:h-[400px] shrink-0">
                    <!-- Editor Toolbar -->
                    <div
                        class="bg-[#0f172a] border-b border-slate-700 px-4 py-2 flex items-center justify-between text-xs">
                        <span class="text-slate-400 font-mono">query.sql</span>
                        <div class="flex gap-2">
                            <span class="text-slate-500">SQLite 3.39</span>
                        </div>
                    </div>

                    <div class="flex-1 flex relative">
                        <!-- Line Numbers -->
                        <div
                            class="w-10 bg-[#0f172a] border-r border-slate-700 text-right pr-2 pt-4 text-slate-600 font-mono text-xs select-none">
                            1<br>2<br>3<br>4<br>5
                        </div>
                        <!-- Textarea -->
                        <textarea id="sql-input"
                            class="flex-1 bg-[#1e293b] text-slate-100 p-4 font-mono text-sm focus:outline-none resize-none leading-relaxed"
                            placeholder="-- Enter your SQL query here&#10;SELECT * FROM dataset LIMIT 10;"
                            spellcheck="false"></textarea>
                    </div>
                </div>

                <!-- Results Pane -->
                <div
                    class="flex flex-col bg-[#0f172a] rounded-xl border border-slate-700 shadow-xl overflow-hidden min-h-[300px]">
                    <div class="px-6 py-3 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Query Results</span>
                        <button onclick="runQuery()"
                            class="px-5 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-xs font-bold rounded-lg shadow-lg shadow-cyan-500/20 transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                            <span>‚ñ∂</span> Run Query
                        </button>
                    </div>
                    <div id="sql-results" class="flex-1 overflow-auto p-4 font-mono text-xs custom-scrollbar">
                        <div class="flex flex-col items-center justify-center p-12 opacity-30">
                            <span class="text-4xl mb-2">‚ö°</span>
                            <p>Results will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PYTHON TAB -->
            <div id="view-python" class="tab-view hidden p-8 space-y-8">
                <!-- Editor Section -->
                <div
                    class="flex flex-col bg-[#1e293b] rounded-xl overflow-hidden border border-slate-700 shadow-xl h-[300px] md:h-[400px] shrink-0">
                    <div
                        class="bg-[#0f172a] border-b border-slate-700 px-4 py-2 text-xs text-slate-400 flex justify-between">
                        <span class="font-mono">analysis.py</span>
                        <span class="text-slate-500">Pandas Loaded</span>
                    </div>
                    <textarea id="python-input"
                        class="flex-1 bg-transparent text-slate-300 p-4 focus:outline-none resize-none font-mono text-sm leading-relaxed"
                        placeholder="# import pandas as pd&#10;# df is already loaded&#10;print(df.describe())"
                        spellcheck="false"></textarea>
                </div>

                <!-- Output Section -->
                <div
                    class="flex flex-col bg-[#0f172a] rounded-xl border border-slate-700 shadow-xl overflow-hidden min-h-[300px]">
                    <div class="px-6 py-3 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Console Output</span>
                        <button onclick="runPython()"
                            class="px-5 py-2 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 text-white text-xs font-bold rounded-lg shadow-lg shadow-emerald-500/20 transition-all flex items-center gap-2 transform hover:-translate-y-0.5">
                            <span>‚ñ∂</span> Run Script
                        </button>
                    </div>
                    <div id="python-output"
                        class="flex-1 bg-[#0a0f1c] p-4 font-mono text-xs text-green-400 overflow-auto custom-scrollbar">
                        <div class="opacity-50 italic"># Output will appear here...</div>
                    </div>
                </div>
            </div>

            <!-- SUBMIT TAB -->
            <div id="view-submit" class="tab-view hidden p-12">
                <div class="glass p-12 rounded-2xl text-center space-y-8 max-w-2xl mx-auto border border-slate-700/50">
                    <div class="w-20 h-20 bg-cyan-500/20 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-4xl">üèÜ</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">Ready to Close the Case?</h2>
                        <p class="text-slate-400">Ensure all objectives are checked off. Your findings will be final.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left max-w-lg mx-auto">
                        <div class="p-4 rounded-lg bg-slate-800 border border-slate-700">
                            <span class="text-xs uppercase text-slate-500 font-bold block mb-1">XP Earned</span>
                            <span class="text-2xl font-bold text-yellow-400">0 / {{ case.xp_reward }}</span>
                        </div>
                        <div class="p-4 rounded-lg bg-slate-800 border border-slate-700">
                            <span class="text-xs uppercase text-slate-500 font-bold block mb-1">Status</span>
                            <span class="text-lg font-bold text-cyan-400">In Progress</span>
                        </div>
                    </div>

                    <button
                        class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-xl shadow-lg shadow-purple-500/20 transform hover:-translate-y-0.5 transition-all w-full max-w-xs">
                        Submit Final Report
                    </button>
                </div>
            </div>

        </div>

        <!-- Footer Info -->
        <div
            class="h-8 bg-[#0a0f1c] border-t border-slate-800 flex items-center px-4 text-[10px] text-slate-600 font-mono justify-between shrink-0">
            <span class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> SYSTEM ONLINE
            </span>
            <span>SECURE CONNECTION</span>
        </div>
    </div>

</div>

<!-- Tab Switching Script & Excel Logic -->
<script>
    function switchTab(tabId) {
        // Hide all views
        document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
        // Show selected view
        const view = document.getElementById('view-' + tabId);
        view.classList.remove('hidden');

        // Reset scroll position
        const contentArea = document.getElementById('content-area');
        if (contentArea) contentArea.scrollTop = 0;

        // Reset tab styling
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('bg-slate-800', 'text-white');
            el.classList.add('text-slate-400');
        });

        // Active tab styling
        const activeBtn = document.getElementById('tab-' + tabId);
        if (activeBtn) {
            activeBtn.classList.remove('text-slate-400');
            activeBtn.classList.add('bg-slate-800', 'text-white');
        }
    }

    async function runQuery() {
        const queryInput = document.getElementById('sql-input');
        const resultsDiv = document.getElementById('sql-results');
        const query = queryInput.value;

        if (!query) return;

        resultsDiv.innerHTML = '<div class="text-cyan-400 animate-pulse">Running query...</div>';

        try {
            const response = await fetch('{% url "execute_query" case.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();

            if (data.success) {
                // Build Table
                let tableHtml = '<table class="w-full text-left text-xs text-slate-300 border-collapse table-auto">';

                // Headers
                tableHtml += '<thead class="bg-slate-800 text-slate-400"><tr>';
                data.columns.forEach(col => {
                    tableHtml += `<th class="px-3 py-2 border-b border-slate-700">${col}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                // Rows
                data.rows.forEach(row => {
                    tableHtml += '<tr class="hover:bg-slate-800/50">';
                    row.forEach(cell => {
                        tableHtml += `<td class="px-3 py-2 border-b border-slate-800/50 border-r border-slate-800/30 truncate max-w-[150px]">${cell}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table>';

                if (data.rows.length === 0) {
                    tableHtml = '<div class="text-slate-500 italic p-4">Query returned no results.</div>';
                }

                resultsDiv.innerHTML = tableHtml;
            } else {
                resultsDiv.innerHTML = `<div class="text-red-400 font-mono p-2 bg-red-500/10 rounded border border-red-500/20">Error: ${data.error}</div>`;
            }

        } catch (error) {
            resultsDiv.innerHTML = `<div class="text-red-400">Network Error: ${error}</div>`;
        }
    }

    async function runPython() {
        const codeInput = document.getElementById('python-input');
        const outputDiv = document.getElementById('python-output');
        const code = codeInput.value;

        if (!code) return;

        outputDiv.innerHTML = '<div class="text-emerald-400 animate-pulse">Running script...</div>';

        try {
            const response = await fetch('{% url "execute_python" case.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ code: code })
            });

            const data = await response.json();

            if (data.success) {
                // Formatting output: Handle newlines
                let safeOutput = data.output ? data.output.replace(/\n/g, '<br>') : '<span class="italic opacity-50">No output returned. Did you print()?</span>';
                let html = `<div class="text-green-400 whitespace-pre-wrap font-mono">${data.output || "No output."}</div>`;

                if (data.is_correct) {
                    html += `<div class="mt-4 p-3 bg-green-500/20 border border-green-500/50 rounded text-green-300 font-bold flex items-center gap-2">
                        <span>‚úÖ</span> ${data.validation_message}
                     </div>`;
                } else if (data.validation_message) {
                    html += `<div class="mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded text-red-300 font-bold flex items-center gap-2">
                        <span>‚ùå</span> ${data.validation_message} <span class="text-xs font-normal opacity-70 ml-2">(Your output didn't match the expected result)</span>
                     </div>`;
                }
                outputDiv.innerHTML = html;

            } else {
                // Show Error
                let errorMsg = data.error || "Unknown Error";
                // Show partial output if any, then error
                let content = "";
                if (data.output) {
                    content += `<div class="text-slate-400 mb-2 border-b border-slate-700 pb-2">${data.output}</div>`;
                }
                content += `<div class="text-red-400 whitespace-pre-wrap font-mono bg-red-900/20 p-2 rounded border border-red-500/30">${errorMsg}</div>`;
                outputDiv.innerHTML = content;
            }

        } catch (error) {
            outputDiv.innerHTML = `<div class="text-red-400">Network Error: ${error}</div>`;
        }
    }

    // --- Excel-like Sorting & Filtering Logic ---
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.querySelector('.custom-scrollbar table');
        const headers = table.querySelectorAll('th:not(:first-child)'); // Skip index column
        const tbody = table.querySelector('tbody');
        const originalRows = Array.from(tbody.querySelectorAll('tr'));

        let activeFilters = {}; // { colIndex: 'value' }

        headers.forEach((th, index) => {
            const realIndex = index + 1; // +1 because of index column
            const filterIcon = th.querySelector('span');

            // Toggle Filter Menu on Icon Click
            if (filterIcon) {
                filterIcon.onclick = (e) => {
                    e.stopPropagation();
                    // Close existing dropdowns
                    document.querySelectorAll('.filter-dropdown').forEach(el => el.remove());

                    // Create Dropdown
                    const dropdown = document.createElement('div');
                    dropdown.className = 'filter-dropdown absolute bg-slate-800 border border-slate-700 shadow-xl rounded-lg p-2 z-50 text-xs text-slate-300 min-w-[150px] max-h-[200px] overflow-y-auto custom-scrollbar flex flex-col gap-1';
                    dropdown.style.left = e.pageX + 'px';
                    dropdown.style.top = e.pageY + 'px';

                    // Get unique values for this column
                    const values = new Set();
                    originalRows.forEach(row => {
                        const cell = row.querySelectorAll('td')[realIndex];
                        if (cell) values.add(cell.innerText.trim());
                    });

                    // Add "Clear Filter" option
                    const clearBtn = document.createElement('div');
                    clearBtn.className = 'px-2 py-1 hover:bg-slate-700 cursor-pointer text-cyan-400 font-bold border-b border-slate-700 mb-1';
                    clearBtn.innerText = 'Clear Filter';
                    clearBtn.onclick = () => {
                        delete activeFilters[realIndex];
                        applyFilters();
                        dropdown.remove();
                    };
                    dropdown.appendChild(clearBtn);

                    // Add unique values
                    Array.from(values).sort().forEach(val => {
                        const item = document.createElement('div');
                        item.className = 'px-2 py-1 hover:bg-slate-700 cursor-pointer rounded flex items-center gap-2';
                        // Checkbox style
                        const isChecked = activeFilters[realIndex] === val;
                        item.innerHTML = `<span class="w-3 h-3 border border-slate-600 rounded ${isChecked ? 'bg-cyan-500 border-cyan-500' : ''}"></span> ${val || '(Empty)'}`;

                        item.onclick = () => {
                            if (activeFilters[realIndex] === val) {
                                delete activeFilters[realIndex]; // Toggle off
                            } else {
                                activeFilters[realIndex] = val; // Set filter (single select for now)
                            }
                            applyFilters();
                            dropdown.remove();
                        };
                        dropdown.appendChild(item);
                    });

                    document.body.appendChild(dropdown);

                    // Close on click outside
                    const closeFn = (ev) => {
                        if (!dropdown.contains(ev.target) && ev.target !== filterIcon) {
                            dropdown.remove();
                            document.removeEventListener('click', closeFn);
                        }
                    };
                    setTimeout(() => document.addEventListener('click', closeFn), 10);
                };
            }

            // Sorting on Header Click
            th.addEventListener('click', () => {
                const isAsc = th.getAttribute('data-order') !== 'asc';
                th.setAttribute('data-order', isAsc ? 'asc' : 'desc');

                // Reset other headers
                headers.forEach(h => { if (h !== th) h.removeAttribute('data-order'); });

                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    const cellA = a.querySelectorAll('td')[realIndex].innerText.trim();
                    const cellB = b.querySelectorAll('td')[realIndex].innerText.trim();

                    // Try numeric sort
                    const numA = parseFloat(cellA);
                    const numB = parseFloat(cellB);

                    if (!isNaN(numA) && !isNaN(numB)) {
                        return isAsc ? numA - numB : numB - numA;
                    }
                    return isAsc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
                });

                tbody.append(...rows); // Re-append sorted rows
            });
        });

        function applyFilters() {
            originalRows.forEach(row => {
                let show = true;
                for (const [colIndex, filterVal] of Object.entries(activeFilters)) {
                    const cell = row.querySelectorAll('td')[colIndex];
                    if (cell.innerText.trim() !== filterVal) {
                        show = false;
                        break;
                    }
                }
                row.style.display = show ? '' : 'none';
            });
        }
    });
</script>

{% endblock %}